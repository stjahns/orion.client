<!DOCTYPE html>
<html>
<head>
<meta name="copyright" content="Copyright (c) IBM Corporation and others 2010."/>
<meta http-equiv="PRAGMA" content="NO-CACHE"/>
<meta http-equiv="Expires" content="-1"/>
<title>Orion TextView Demo</title>
<style>
.button {
  border: 2px dotted orange;
  padding: 0 2 0 2
}
</style>

<script language="javascript" type="text/javascript" src="/orion/textview/keyBinding.js"></script>
<script language="javascript" type="text/javascript" src="/orion/textview/textModel.js"></script>
<script language="javascript" type="text/javascript" src="/orion/textview/textView.js"></script>
<script language="javascript" type="text/javascript" src="/orion/textview/rulers.js"></script>
<script language="javascript" type="text/javascript" src="/orion/textview/undoStack.js"></script>
<script language="javascript" type="text/javascript" src="/examples/textview/textStyler.js"></script>
<script language="javascript" type="text/javascript" src="/js-tests/textview/test-performance.js"></script>

<script language="javascript" type="text/javascript">
var view = null;
var styler = null;

var isMac = navigator.platform.indexOf("Mac") !== -1;

function log (text) {
	var console = window.document.getElementById('console');
	if (!console) { return; }
	for (var n = 1; n < arguments.length; n++) {
		text += " ";
		text += arguments[n];
	}
	
	var document = console.contentWindow.document;
	var t = document.createTextNode(text);
	document.body.appendChild(t);
	var br = document.createElement("br");
	document.body.appendChild(br);
	if (!console.scroll) {
		console.scroll = true;
		setTimeout(function() {
			document.body.lastChild.scrollIntoView(false);
			console.scroll = false;
		}, 0);
	}
	
	//IE (causes all kinds of weird behaviour)
//	console.log(text);
}

function clearLog () {
	var console = window.document.getElementById('console');
	if (!console) { return; }
	var document = console.contentWindow.document;
	var body = document.body;
	while (body.hasChildNodes()) { body.removeChild(body.lastChild); }
}

function getFile(file) {
	try {
		var objXml = new XMLHttpRequest();
		objXml.open("GET",file,false);
		objXml.send(null);
		return objXml.responseText;
	} catch (e) {
		return null;
	}
}

function checkView() {
	if (view) return;
	var stylesheets = [
		"/orion/textview/textview.css",
		"/orion/textview/rulers.css",
		"/examples/textview/textstyler.css",
	];
	var options = {
		parent: "divParent",
		model: new orion.textview.TextModel(),
		stylesheet: stylesheets,
		tabSize: 4,
	};
	view = new orion.textview.TextView(options);
	
	/* Undo stack */
	var undoStack = new orion.textview.UndoStack(view, 200);
	view.setKeyBinding(new orion.textview.KeyBinding('z', true), "undo");
	view.setAction("undo", function() {
		undoStack.undo();
		return true;
	});
	view.setKeyBinding(isMac ? new orion.textview.KeyBinding('z', true, true) : new orion.textview.KeyBinding('y', true), "redo");
	view.setAction("redo", function() {
		undoStack.redo();
		return true;
	});
	
	view.setKeyBinding(new orion.textview.KeyBinding('s', true), "save");
	view.setAction("save", function() {
		log("*****************SAVE");
		return true;
	});
	view.setKeyBinding(new orion.textview.KeyBinding('f', true), "find");
	view.setAction("find", function() {
		log("*****************FIND");
		return true;
	});
	
	var breakpoint = {
		html: "<img src='images/brkp_obj.gif'></img>",
		style: {styleClass: "ruler_annotation_breakpoint"},
		overviewStyle: {styleClass: "ruler_annotation_breakpoint_overview"}
	};
	var todo = {
		html: "<img src='images/todo.gif'></img>",
		style: {styleClass: "ruler_annotation_todo"},
		overviewStyle: {styleClass: "ruler_annotation_todo_overview"}
	};
	var annotation = new orion.textview.AnnotationRuler("left", {styleClass: "ruler_annotation"}, breakpoint);
	annotation.onDblClick =  function(lineIndex, e) {
		if (lineIndex === undefined) return;
		annotation.setAnnotation(lineIndex, annotation.getAnnotation(lineIndex) !== undefined ? undefined : e.ctrlKey ? todo : breakpoint);
	};
	var lines = new orion.textview.LineNumberRuler("left", {styleClass: "ruler_lines"}, {styleClass: "ruler_lines_odd"}, {styleClass: "ruler_lines_even"});
	lines.onDblClick = annotation.onDblClick;
	var overview = new orion.textview.OverviewRuler("right", {styleClass: "ruler_overview"}, annotation);
	view.addRuler(annotation);
	view.addRuler(lines);
	view.addRuler(overview);
}

function createJavaSample() {
	checkView();
	var file =  getFile("text.txt");
	if (styler) {
		styler.destroy();
		styler = null;
	}
	styler = new examples.textview.TextStyler(view, "java");
	view.setText(file);
}

function createJavaScriptSample() {
	checkView();
	var file =  getFile("/orion/textview/textview.js");
	if (styler) {
		styler.destroy();
		styler = null;
	}
	styler = new examples.textview.TextStyler(view, "js");
	view.setText(file);
}

function createPlainTextSample() {
	checkView();
	var lineCount = 50000;
	var lines = [];
	for(var i = 0; i < lineCount; i++) {
		lines.push("This is the line of text number "+i);
	}
	if (styler) {
		styler.destroy();
		styler = null;
	}
	view.setText(lines.join("\r\n"));
}

function createBidiTextSample() {
	checkView();
	var lines = [];
	lines.push("Hello \u0644\u0645\u0646\u0647");
	if (styler) {
		styler.destroy();
		styler = null;
	}
	view.setText(lines.join("\r\n"));
}

function test() {
}

function performanceTest() {
	checkView();
	if (styler) {
		styler.destroy();
		styler = null;
	}
	var test = new PerformanceTest(view);
	var select = document.getElementById("test");
	test[select.value]();
}


</script>
</head>
<body>

<h1>Orion Text View Demo</h1>

<table width="100%">
<tr>
<th>View</th>
<th>Console</th>
</tr>
<tr>
<td width="100%">
<div id='divParent' style='border: 1px solid teal;width:100%;height:650px;'>
Create the view by clicking one of the buttons at the bottom.
</div>
</td>
<td>
<div id='divParent' style='border: 1px solid teal;width:300px;height:650px;'>
<iframe id='console' frameBorder="0" style="width:100%;height:100%;"></iframe>
</div>
</td>
</tr>
</table>
<span onclick='createJavaSample()' class="button">Java file</span>
<span onclick='createJavaScriptSample()' class="button">JavaScript file</span>
<span onclick='createPlainTextSample()' class="button">Plain Text</span>
<span onclick='createBidiTextSample()' class="button">Bidi Text</span>
<span onclick='clearLog()' class="button">ClearConsole</span>
<span onclick='test()' class="button">Test</span>
Performance tests:
<select id="test">
  <option value="test_pageDown">Page Down</option>
  <option value="test_pageUp">Page Up</option>
  <option value="test_lineDown">Line Down</option>
  <option value="test_lineUp">Line Up</option>
  <option value="test_selectPageDown">Select Page Down</option>
  <option value="test_selectPageUp">Select Page Up</option>
  <option value="test_selectLineDown">Select Line Down</option>
  <option value="test_selectLineUp">Select Line Up</option>
  <option value="test_getLocationAtOffset">Location at Offset</option>
  <option value="test_getOffsetAtLocation">Offset at Location</option>
  <option value="test_getLocationAtOffsetStyled">Location at Offset[styles]</option>
  <option value="test_getOffsetAtLocationStyled">Offset at Location[styles]</option>
</select>
<span onclick='performanceTest()' class="button">Run</span>
</body>
</html>
